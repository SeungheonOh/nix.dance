#!/bin/bash

######### User interaction

prompt() {
    read -r "$@" </dev/tty
}

yes-no-prompt() {
    local response
    while :; do
        read -r -p "$@ [Y/n]" </dev/tty response
        if [[ "${response,,}" =~ y|yes ]]; then
            return 0
        elif [[ "${response,,}" =~ n|no ]]; then
            return 1
        fi
        echo "I didn't quite get that"
    done
}

log-info() {
    echo "[\e[33mINFO\e[0m ] $*"
}

######### Config gen

create-envrc() {
  cat <<EOF > .envrc
if ! has nix_direnv_version || ! nix_direnv_version 2.1.1; then
  source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/2.1.1/direnvrc" "sha256-b6qJ4r34rbE23yWjMqbmu3ia2z4b2wIlZUksBke/ol0="
fi
use flake
EOF
}

clear

if ! hash nix; then
    prompt -p "do you want to install nix? [Y/n]"

    echo instaling nix
    exit 0
fi

log-info CREATING .envrc

if [ -f .envrc ]; then
    if yes-no-prompt ".envrc file found, replace it?"; then
        create-envrc
    fi
else
    create-envrc
fi

